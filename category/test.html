<!DOCTYPE html>
<html lang="zh-cn">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Welcome to YZSH-HSZY blog. - Test</title>
                        <link rel="stylesheet" href="https://yzsh-hszy.github.io/theme/css/main.css" />
                                <link href="https://yzsh-hszy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Welcome to YZSH-HSZY blog. Atom Feed" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="https://yzsh-hszy.github.io/">Welcome to YZSH-HSZY blog.</a></h1>
                        <nav><ul>
                                                <li><a href="https://yzsh-hszy.github.io/category/cpython.html">Cpython</a></li>
                                                <li><a href="https://yzsh-hszy.github.io/category/linux.html">Linux</a></li>
                                                <li><a href="https://yzsh-hszy.github.io/category/mindspore.html">Mindspore</a></li>
                                                <li><a href="https://yzsh-hszy.github.io/category/qemu.html">Qemu</a></li>
                                                <li><a href="https://yzsh-hszy.github.io/category/qt.html">Qt</a></li>
                                                <li class="active"><a href="https://yzsh-hszy.github.io/category/test.html">Test</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="https://yzsh-hszy.github.io/2024-12-30-multiprocess-blog.html">multiprocess blog.</a></h1>
<footer class="post-info">
        <abbr class="published" title="2024-12-30T19:00:00+08:00">
                Published: Mon 30 December 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="https://yzsh-hszy.github.io/author/yzsh-hszy.html">YZSH-HSZY</a>
                </address>
        <p>In <a href="https://yzsh-hszy.github.io/category/test.html">Test</a>.</p>
        
</footer><!-- /.post-info --><h1>笔记介绍</h1>
<p>该笔记用于记录工作中多进程相关问题和学习笔记.主要为python语言.
<a href="https://docs.python.org/zh-cn/3/library/multiprocessing.html">参阅官方多进程文档获取详细说明</a></p>
<blockquote>
<p>python内部提供一个multiprocessing模块, 其支持使用与 threading 模块类似的 API 来操作进程。可用其来绕过GIL</p>
</blockquote>
<h2>环境准备</h2>
<pre><code class="language-python">import os
from os.path import splitext, join, dirname, basename, abspath
import multiprocessing

print(f&quot;current ipynb path is: {os.getcwd()}&quot;)
print(f&quot;mkdir cache dir in order to run py in shell&quot;)

os.makedirs('.cache', exist_ok=True)

print(f&quot;\ncreate dir {join(os.getcwd(), '.cache')} success.&quot;)
</code></pre>
<pre><code>current ipynb path is: /home/smartwork/work/mblog/process
mkdir cache dir in order to run py in shell

create dir /home/smartwork/work/mblog/process/.cache success.
</code></pre>
<p><strong>注意</strong> multiprocessing 需要能够通过 <code>__main__</code> 模块加载target, 因此在一些交互式环境中无法使用.如在 jupyter 中无法运行, 可使用外置shell执行 <code>!python &lt;py_file&gt;</code>. 此处暂不深究repl中可加载 <code>__main__</code> 但仍无法运行multiprocess</p>
<h2>multiprocessing的支持上下文</h2>
<ol>
<li>spawn, 父进程启动一个新的python解释器进程. 子进程只继承运行进程对象的 run() 方法所必须的资源。</li>
<li>fork, 在posix系统上可用.</li>
<li>forkserver</li>
</ol>
<p>其中,在window上默认使用 <code>spawn</code> 方式启动</p>
<h2>spawn探讨</h2>
<pre><code class="language-python">%%writefile .cache/test_spwan.py
import multiprocessing

print(&quot;import running output.&quot;)

def spawn_example():
    print(f&quot;{8**9}&quot;)

if __name__ == &quot;__main__&quot;:
    multiprocessing.set_start_method('spawn', force=True)
    print(&quot;current mp start method is: &quot;,  multiprocessing.get_start_method())

    t = multiprocessing.Process(target=spawn_example)
    t.start()
    t.join()
</code></pre>
<pre><code>Overwriting .cache/test_spwan.py
</code></pre>
<pre><code class="language-python">!python .cache/test_spwan.py
</code></pre>
<pre><code>import running output.
current mp start method is:  spawn
import running output.
134217728
</code></pre>
<p>从上述执行结果中可以看到, <code>import running output.</code> 输出了两次. 一次为python运行时解析执行的print语句,</p>
<pre><code class="language-python">import collections
from dataclasses import dataclass
from enum import Enum
from functools import lru_cache
import math
import multiprocessing.context
import multiprocessing.pool
import multiprocessing.shared_memory
import multiprocessing.synchronize
from random import randint
import shutil
import struct
import os
from threading import Thread
from typing import Any, Dict, List, Optional, Tuple, Type, Union
from warnings import warn
import tqdm
from os.path import join, basename, dirname, splitext, isdir, isfile, isdir
from glob import glob

from math import pi as PI
from math import log, tan, atan, exp

from datetime import datetime
import numpy as np
import multiprocessing as mp
from multiprocessing.sharedctypes import Value, Array
from multiprocessing import Pool, Lock, Queue
import queue

from PyQt5.QtCore import QVariant
from qgis.core import QgsFeature, QgsGeometry, QgsPointXY, QgsProject, QgsApplication, QgsVectorLayer
from qgis.gui import QgisInterface
from qgis.utils import iface
from qgis._core import QgsCoordinateReferenceSystem, QgsFields, QgsField, QgsVectorFileWriter, QgsWkbTypes, QgsProject, QgsVectorLayer
from qgis._core import QgsApplication

def LonLat2WebMercator(lon, lat):
  &quot;&quot;&quot;
    lonLat is from GPS's WGS84
    webMercator is the fromat in baidumap, googlemap
    longitude and latitude to web Mercator
  &quot;&quot;&quot;
  x = lon*20037508.34/180
  y = log(tan((90+lat)*PI/360))/(PI / 180)
  y = y*20037508.34/180
  return [x, y]

def WebMercator2LonLat( x, y ):
  &quot;&quot;&quot;
    web Mercator to longitude and latitude
  &quot;&quot;&quot;
  lon = x/20037508.34*180
  lat = y/20037508.34*180
  lat = 180/PI*(2*atan(exp(lat*PI/180))-PI/2)
  return [lon, lat]

@dataclass
class A:
    i: int
    l: list
    d: dict

@dataclass
class Point:
    x: float
    y: float
    def to_qgs_geometry(self) -&gt; QgsGeometry:
        return QgsGeometry.fromPointXY(QgsPointXY(*WebMercator2LonLat(self.x, self.y)))
    def handle_convert_geometry(self, 
            attrs: QgsFields, val_dicts: Dict[str, Any], layer: QgsVectorLayer = None) -&gt; QgsGeometry:
        return self.to_qgs_geometry()

@dataclass
class Point25D:
    x: float
    y: float
    depth: float
    def to_qgs_geometry(self) -&gt; QgsGeometry:
        return QgsGeometry.fromPointXY(QgsPointXY(*WebMercator2LonLat(self.x, self.y)))
    def handle_convert_geometry(self, 
            attrs: QgsFields, val_dicts: Dict[str, Any], layer: QgsVectorLayer = None) -&gt; QgsGeometry:
        # if layer is not None: 
        #     layer.addAttribute(QgsField(&quot;depth&quot;, QVariant.String, None, 254))
        #     feature.setAttribute(&quot;depth&quot;, str(self.depth))
        if &quot;depth&quot; not in attrs.names(): 
            attrs.append(QgsField(&quot;depth&quot;, QVariant.String, None, 254))
        elif not val_dicts.get(&quot;depth&quot;, &quot;&quot;):
            # warn(f'Point25D 类型对应layer中, depth字段已存在,参{val_dicts},self.depth:{str(self.depth)}')
            pass
        else:
            warn(f'Point25D 类型对应layer中, depth字段已存在,参{val_dicts},self.depth:{str(self.depth)}')

        val_dicts['depth'] = str(self.depth)
        return self.to_qgs_geometry()

@dataclass
class Pline:
    minx: float
    miny: float
    maxx: float
    maxy: float
    points_number: int
    repeat_points: List[Point]
    def to_qgs_geometry(self) -&gt; QgsGeometry:
        if self.points_number != len(self.repeat_points):
            warn(
                f&quot;points_number is not equal to repeat_points, &quot;
                f&quot;points_number = {self.points_number}, repeat_points = {len(self.repeat_points)}&quot;)
        return QgsGeometry.fromPolylineXY(
            [QgsPointXY(*WebMercator2LonLat(t.x, t.y)) for t in self.repeat_points]
        )
    def handle_convert_geometry(self, 
            attrs: QgsFields, val_dicts: Dict[str, Any], layer: QgsVectorLayer = None) -&gt; QgsGeometry:
        return self.to_qgs_geometry()

MULT_POLYGON_COUNT = 0  # 多部分多边形计数

@dataclass
class Polygon:
    minx: float
    miny: float
    maxx: float
    maxy: float
    polygon_num: int
    repeat_plines: List[Pline]  # 不包含mixx/y,maxx/y
    def to_qgs_geometry(self) -&gt; List[QgsGeometry]:
        if self.polygon_num != len(self.repeat_plines):
            warn(
                f&quot;polygon_num is not equal to repeat_plines, &quot;
                f&quot;polygon_num = {self.polygon_num}, repeat_plines = {len(self.repeat_plines)}&quot;)
        if self.polygon_num &gt; 1:
            warn(
                f'handle multiple polygon. num is :{self.polygon_num}'
            )
        res = []
        for t in self.repeat_plines:
            res.append(QgsGeometry.fromPolygonXY(
                [[QgsPointXY(*WebMercator2LonLat(k.x, k.y)) for k in t.repeat_points]]
            ))
        return res
    def handle_convert_geometry(self, 
            attrs: QgsFields, val_dicts: Dict[str, Any], layer: QgsVectorLayer = None) -&gt; QgsGeometry:
        global MULT_POLYGON_COUNT
        the_geoms = self.to_qgs_geometry()
        for polygon in the_geoms[1:]:
            MULT_POLYGON_COUNT += 1
            # Dat2Shp.add_feature_to_layer(-1, attrs, val_dicts, polygon, layer)
        return the_geoms[0]


def mp_handle_func(mp_queue: Queue):
    for i in range(1, 3):
        t = A(randint(1,10), [1,2], {})
        tt = randint(1,4) 
        if tt == 1:
            t = Point(1.2,2.4)
        if tt == 2:
            t = Polygon(0,1,2,3,1,[Pline(3,4,5,6,1,[Point(8,9)])])
        mp_queue.put(t)
    return mp.current_process().pid

if __name__ == &quot;__main__&quot;:
    multiprocessing.set_start_method('spawn')
    mp_queue = mp.Manager().Queue()
    
    a = A(1, [2,3], {'a':4})
    mp_queue.put(A)
    
    async_res: List[multiprocessing.pool.ApplyResult] = []
    
    with mp.Pool(2) as pool:
        pool: multiprocessing.pool.Pool
        async_res.append(pool.apply_async(mp_handle_func, args=(mp_queue, )))
        async_res.append(pool.apply_async(mp_handle_func, args=(mp_queue, )))
    
        [tem_p.wait() for tem_p in async_res]
    
    try:
        print([tem_p.get() for tem_p in async_res])
        while not mp_queue.empty():
            print(mp_queue.get_nowait())
    except queue.Empty as e:
        print('mp_queue is empty')
    pass

</code></pre>
<p>输出如下:</p>
<pre><code class="language-python">[18952, 5852]
&lt;class '__main__.A'&gt;
A(i=9, l=[1, 2], d={})
A(i=7, l=[1, 2], d={})
Polygon(minx=0, miny=1, maxx=2, maxy=3, polygon_num=1, repeat_plines=[Pline(minx=3, miny=4, maxx=5, maxy=6, points_number=1, repeat_points=[Point(x=8, y=9)])])
A(i=4, l=[1, 2], d={})
</code></pre>
                    </article>
                </aside><!-- /#featured -->
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="https://getpelican.com/">Pelican</a></li>
                                                        <li><a href="https://www.python.org/">Python.org</a></li>
                                                        <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                                                        <li><a href="#">You can modify those links in your config file</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://yzsh-hszy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="#">You can add links in your config file</a></li>
                                                        <li><a href="#">Another social link</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>